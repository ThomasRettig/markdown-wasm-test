<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Markdown Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> <!-- disable zoom in Safari when textarea is focused -->
    <link rel="stylesheet" href="styles.css" inline> <!-- inline CSS -->
    <script src="markdown.js"></script>
    <script src="highlight.js"></script>
    <link rel="stylesheet" href="highlight.css">
    <script src="clipboard.min.js"></script>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="favicon.svg">
    <!-- refer to https://developer.apple.com/design/human-interface-guidelines/ios/icons-and-images/app-icon/ for icon sizes-->
    <link rel="apple-touch-icon" href="apple-touch-icon-180x180.png" sizes="180x180">
  </head>
  <body>
    <grid columns="2">
      <header>
        <c>
          <h1 class="sr-only">Markdown Editor</h1>
        </c>
      </header>
      <c>
      </c>
      <div id="wrapper">
        <c class="label">
          <span id="input-label" class="select-none">Raw Markdown</span>
          <div class="gap select-none">
            <div>
              <button class="btn btn-background" id="clipboard" data-clipboard-target="#markdownInput" aria-label="Copy text to clipboard">
                <c class="btn-label" aria-hidden="true">Copy</c>
                <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M15 20H5V7c0-.55-.45-1-1-1s-1 .45-1 1v13c0 1.1.9 2 2 2h10c.55 0 1-.45 1-1s-.45-1-1-1zm5-4V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2zm-2 0H9V4h9v12z"/></svg>
              </button>
            </div>
            <div>
              <button class="btn btn-background" id="saveBtn" data-title="Save to desktop" aria-label="Save Markdown file to desktop">
                <!-- <c class="btn-label">Save</c> -->
                <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 96 960 960" width="24" height="24"><path d="M840 376v480q0 33-23.5 56.5T760 936H200q-33 0-56.5-23.5T120 856V296q0-33 23.5-56.5T200 216h480l160 160ZM480 816q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM240 496h360V336H240v160Z"/></svg>
              </button>
            </div>
          </div>
        </c>
        <c class="label"></c>
        <c class="input textarea">
          <textarea class="code" id="markdownInput" placeholder="Type something here…" aria-labelledby="input-label" required autofocus># Hello world!&#13;View the [getting started](https://www.markdownguide.org/getting-started/) guide if you are unfamiliar with Markdown.</textarea>
      </c>
    </div>
    <c class="output" id="htmlOutput"></c>
    </grid>
    <div id="statusIndicator" aria-live="polite">Unsaved</div>
    <script>
      // instantiate Markdown parser
      window["markdown"].ready.then((markdown) => {
        const inputEl = document.getElementById("markdownInput");
        const outputEl = document.getElementById("htmlOutput");
        let hljsTimer;

        function update() {
          let source = inputEl.value;
          let html = markdown.parse(source, {
            parseFlags:
              markdown.ParseFlags.DEFAULT |
              markdown.ParseFlags.PERMISSIVE_WWW_AUTOLINKS,
          });
          outputEl.innerHTML = html;
          updateCodeHighlight();
        }

        // syntax highlighting
        function updateCodeHighlight() {
          clearTimeout(hljsTimer);
          if (typeof hljs == "undefined") {
            hljsTimer = setTimeout(updateCodeSyntaxHighlighting, 500);
            return;
          }
          document
            .querySelectorAll('pre code[class^="language-"]')
            .forEach((block) => {
              hljs.highlightElement(block);
            });
        }

        inputEl.addEventListener("input", update);
        update();
      });

      // copy markdown to clipboard
      let clipboard = new ClipboardJS("button");

      // saving functionality

      let fileHandle = null;
      const statusIndicator = document.getElementById("statusIndicator");
      const textArea = document.getElementById("markdownInput");
      textArea.addEventListener("input", () => {
        if (fileHandle) {
          statusIndicator.innerText = "Unsaved";
          statusIndicator.classList.add("visible");
        }
      });

      async function saveTextToFile() {
        const textToWrite = textArea.value;
        if (!fileHandle) {
          const options = {
            suggestedName: "untitled.md",
            types: [
              {
                description: "Text Files",
                accept: {
                  "text/plain": [".md"],
                },
              },
            ],
          };
          fileHandle = await window.showSaveFilePicker(options);
        }
        statusIndicator.innerText = "Saving…";
        statusIndicator.classList.add("visible");
        const writable = await fileHandle.createWritable();
        await writable.write(textToWrite);
        await writable.close();
        statusIndicator.innerText = "Saved";
        setTimeout(() => {
                  statusIndicator.classList.remove("visible");
                }, 2000);
      }

      const saveButton = document.getElementById("saveBtn");
      saveButton.addEventListener("click", saveTextToFile);

      // make textarea resize height automatically
      const tx = document.getElementsByTagName("textarea");
      for (let i = 0; i < tx.length; i++) {
        tx[i].setAttribute(
          "style",
          `height: ${tx[i].scrollHeight}px; overflow-y: hidden;`
        );
        tx[i].addEventListener("input", OnInput, false);
      }

      function OnInput() {
        this.style.height = "auto";
        this.style.height =  `${this.scrollHeight}px`;
      }

      // install service worker
      if (navigator && navigator.serviceWorker) {
        navigator.serviceWorker.register("sw.js");
      }
    </script>
  </body>
</html>
